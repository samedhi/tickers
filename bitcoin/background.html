<script type="text/javascript" src="http://bitcoingae.appspot.com/channel.js"></script> 
<script>
var global = {mtgox: "LOADING", trade: "LOADING", mtgoxHist:[], tradeHist:[]};

function reload(msg){
  console.log(msg);
  setTimeout("window.location.reload()", 60000);
}

try{
  function start(){
    console.log("start() being called");
    var xhr = new XMLHttpRequest();
    xhr.open("GET", "http://bitcoingae.appspot.com/getId", true);
    xhr.onreadystatechange = function() {
      if (xhr.readyState == 4) {
	var text = xhr.responseText;
	console.log("xhr in start() response text is => "+text+"("+new Date()+")");
	if(xhr.status == 200){	
	  var resp = JSON.parse(text);
	  console.log(resp);
	  run(resp.token);
	  global.mtgoxHist = resp["mtgoxHist"];
	  global.tradeHist = resp["tradeHist"];
	}
      }
    };
    xhr.onerror = function(msg){
      reload("error in start() "+ msg.description + " (" + msg.code + ")");
    };
    xhr.send();
  };
  
  function run(token){
    console.log("run()'s token was => "+token);
    if(goog == undefined){
      reload("goog was not defined");
    }
    var channel = new goog.appengine.Channel(token);
    var socket = channel.open();
    
    socket.onmessage = onMessage;
    
    socket.onclose = function(){
      reload("the connection was closed, it threw this error");
    };
    
    socket.onerror = function(msg){
      reload("socket error in run() " + msg.description + " (" + msg.code + ")");
    };
  };
  
  function onMessage(message){
    var data = JSON.parse(message.data);
    console.log("onMessage called with message => " + message.data + " ("+new Date()+")");
    
    var data4 = data.mtgox.toFixed(2).toString().substr(0,4);
    chrome.browserAction.setBadgeText({text: data4});
    
    global.mtgox = data.mtgox.toFixed(2); 
    var mtgox = global.mtgoxHist.slice(1, 1440);
    mtgox.push(data.mtgox);
    global.mtgoxHist = mtgox;
    
    global.trade = data.trade.toFixed(2);
    var trade = global.tradeHist.slice(1, 1440);
    trade.push(data.trade);
    global.tradeHist = trade;
  };

  start();

}catch(err){
  reload(err);
}
</script>
