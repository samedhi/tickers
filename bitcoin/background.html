<!-- <script type="text/javascript" src="http://bitcoingae.appspot.com/_ah/channel/jsapi"></script> -->

<script>
var global = {mtgox: "LOADING", trade: "LOADING", mtgoxHist:[], tradeHist:[]};
var globalChannel = null;

function loadChannel(){
	if(typeof(goog) === "undefined"){
		if(globalChannel != null){
			document.getElementsByTagName("head")[0].removeChild(globalChannel);
		}
		console.log("It appears that the channel api was not imported, importing now");
		globalChannel = document.createElement('script');
		globalChannel.setAttribute("type","text/javascript");
		globalChannel.setAttribute("src", "http://bitcoingae.appspot.com/_ah/channel/jsapi");
		if (typeof globalChannel != "undefined"){
			document.getElementsByTagName("head")[0].appendChild(globalChannel)
		}
		setTimeout("loadChannel()", 10000);
	}else{
		start();
	}
};

function start(){
	var xhr = new XMLHttpRequest();
	xhr.open("GET", "http://bitcoingae.appspot.com/getId", true);
	xhr.onreadystatechange = function() {
		if (xhr.readyState == 4) {
			var text = xhr.responseText;
			console.log("the response text is => "+text);
			var resp = JSON.parse(text);
			console.log(resp);
			run(resp.token);
			global.mtgoxHist = resp["mtgoxHist"];
			global.tradeHist = resp["tradeHist"];
		}
	};
	xhr.onerror = function(){
		console.log(msg.description + " (" + msg.code + ")");
		setTimeout("start()", 1000);
	};
	xhr.send();
};

function run(token){
	console.log("the token passed to run() was => "+token);
	if(token != undefined && token != null){
		console.log("the token was valid, we are starting up and listening for notfications!");
		var channel = new goog.appengine.Channel(token);
		var socket = channel.open();
		
		socket.onmessage = onMessage;
		
		socket.onclose = function(){
			console.log("the connection was closed, starting a new one");
			start();
		};

		socket.onerror = function(msg){
			console.log(msg.description + " (" + msg.code + ")");
			start();
		};
	}
};

function onMessage(message){
	var data = JSON.parse(message.data);
	
	if(data == -1){ return; } //no op, server has not updated.
	
	//update the badge
	var data4 = data.mtgox.toString().substr(0,4);
	chrome.browserAction.setBadgeText({text: data4});
	
	//update the popup
	if(data.mtgox != undefined){ 
		global.mtgox = data.mtgox.toFixed(2); 
		var mtgox = global.mtgoxHist.slice(1, 1440);
		mtgox.push(data.mtgox);
		global.mtgoxHist = mtgox;
	}
	if(data.trade != undefined){ 
		global.trade = data.trade.toFixed(2);
		var trade = global.tradeHist.slice(1, 1440);
		trade.push(data.trade);
		global.tradeHist = trade;
	}
};

loadChannel();

// chrome.browserAction.onClicked.addListener(
//	function(){
//		chrome.tabs.create({url:"https://mtgox.com/"})
//	}
//);
</script>